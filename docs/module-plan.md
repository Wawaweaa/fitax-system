# 模块化开发规划

本项目的 P0 范围按照“开发 → 测试 → 提交 Codex 验收”顺序划分为以下 6 个模块。每个模块完结前必须完成对应的单元/集成/E2E 测试，并等待 Codex 验收后方可进入下一模块。

## 模块 A：wechat_video 全流程（merge + Parquet + 金样）
- 内容：实现 wechat_video 平台的 S0/S1、Worker merge 逻辑、Parquet 真相、有效视图、API 读取、导出 CSV/XLSX。
- 数据：使用 `demo-1024-视频号模型_规则样例_251026.xlsx`、`demo-视频号订单结算8月_样例_251026.xlsx` 等真实样本与 expected CSV。
- 测试：补齐单元测试（适配器 row_key/row_hash、金额恒等式）、E2E（上传→处理→导出→金样 diff=0）。
- 输出：提交实现与测试结果，由 Codex 验收。

## 模块 B：xiaohongshu 管道
- 前置：模块 A 验收通过。
- 内容：按同一规范实现小红书 S0/S1、merge/replace、Parquet 写入、有效视图、API 支持。
- 数据：使用 `demo-1024-小红书模型_规则样例_251026.xlsx`、`demo-小红书结算明细8月_样例_251026.xlsx`、`demo-小红书订单明细8月_样例_251026.xlsx` 等。
- 测试：单测 + E2E（金样 diff=0）。
- 输出：提交实现与测试结果，由 Codex 验收。

## 模块 C：douyin 管道
- 前置：模块 A、B 均验收通过。
- 内容：实现抖音 S0/S1（含空白清洗、注释过滤）、merge/replace、Parquet、有效视图、API。
- 数据：使用 `demo-1024-抖音模型_规则样例_251026.xlsx`、`demo-抖音结算8月_样例_251026.xlsx`、`demo-抖音订单8月_样例_251026.xlsx`。
- 测试：单测 + E2E（金样 diff=0，恒等式成立）。
- 输出：提交实现与测试结果，由 Codex 验收。

## 模块 D：前端联调与导出整合
- 前置：三个平台管道均验收。
- 内容：前端接通 upload → process (含模式选择、重复提示) → job 状态 → 预览 (行级/汇总) → 导出；导出按钮附带视图参数；UI 错误/空态/骨架统一。
- 测试：前端自测（交互验证）、必要的 API 集成测试。
- 输出：记录操作步骤与结果，由 Codex 验收。

## 模块 E：金样 E2E 套件与 CI
- 内容：准备 fixtures/expected CSV；实现 Vitest E2E 脚本（上传→处理→导出→金样 diff）；补充关键单元测试；配置 CI 工作流。
- 测试：CI 中执行 E2E（diff=0）、单测通过。
- 输出：提交测试结果，由 Codex 验收。

## 模块 F：部署与运维最小化
- 内容：编写 staging-intl 部署脚本/文档（Vercel + S3 + 队列 + Worker）；提供 `.env.example`；记录运行手册；补充日志/监控最小集。
- 测试：在 staging 环境跑通完整链路，记录操作日志。
- 输出：提交部署文档与验证结果，由 Codex 验收。

---

每个模块完成后必须：
1. 说明修改的文件与实现要点；
2. 附上运行的测试命令与结果；
3. 列出遗留风险并更新 `docs/OpenIssues.md`；
4. 等待 Codex 审核通过，再进入下一模块。
