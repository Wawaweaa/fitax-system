# Engineering Standards v1.1（在 v1.0 基础上补齐的必要条款）

1) 安全（MVP必做的“低成本高收益”）
- 传输/存储：HTTPS 全程；对象存储私有桶 + 预签名 URL；本地/云存储均禁止目录列举。
- 凭据：统一 .env 校验（envalid/zod），严禁把密钥写死在代码；区分 dev/staging/prod。
- 上传：MIME + 扩展名两次校验；大小/文件数限额（默认 50MB/次，可配）；仅 .xlsx/.csv 白名单。
- 输入：服务端对 platform/year/month/sku 做白名单与类型校验；输出默认 JSON 序列化。
- Web：CORS 只允许前端域名；开启安全头（X-Content-Type-Options, X-Frame-Options, CSP 简版）。
- 审计：记录关键操作日志（userId、平台、年月、作业id、耗时、结果/错误码）。

2) 多租户与数据治理
- 租户隔离：所有路径/键/表均以 userId 前缀；禁止“默认公共空间”写入。
- 去重与模式：datasets.json 记录 sha256 与 mode=replace|merge；相同 sha256 幂等跳过。
- 生命周期：样例/测试数据的保留与清理周期（例如 30 天）；导出文件临时 URL 1 小时失效。

3) 可靠性与队列
- Upstash：生产/测试使用不同实例；队列消息有超时、重试（指数退避 3 次）与死信队列。
- 幂等键：process 作业入队以 (userId, platform, year, month, sha256) 作为幂等键。
- 失败可恢复：失败作业能 retry；导出接口对缺失产物给出“可恢复”提示（引导先处理）。

4) 观测与指标（最小可观测集）
- 计数：上传次数、去重命中、处理成功/失败数、导出成功/失败数。
- 时延：处理链路 p50/p95/p99（从入队到产出），导出生成时长。
- 质量：恒等式失败行数、空 SKU 比例、跨表匹配失败率。
- 日志：Worker 启动打印 queue/url/token；保留“reserved jobId / done jobId”。

5) 性能与容量（明确边界）
- DuckDB：内存上限、并发上限、数据分块（>10万行 CSV/XLSX 分块读取）。
- 表格前端：虚拟滚动默认开启，单页最多渲染 5,000 行；导出拆分多 Sheet（>1,048,576 行）。
- 上传限流：每用户并发处理 ≤ 2；请求超时与后端队列排队提示。

6) 适配器与口径（对业务最关键）
- 统一 schema.ts：A–O 15 列 + 汇总 6 列的字段名/类型/计算口径集中定义；任何适配器**必须**返回这套结构。
- 恒等式强校验：收入合计 − 平台佣金 − 其他费用 ≡ 应到账金额（误差 ≤ 0.01），不通过即失败。
- 版本化：适配器含 version；当口径变更时提升版本并在预览页显著提示“本月口径版本”。

7) 测试金字塔（MVP配套）
- 单测：适配器的列映射/边界值（空白、编码异常、重复行）。
- 属性测试：随机生成交易明细，校验恒等式与汇总守恒。
- 合同测试（CDC）：/api/preview 与前端消费模型的契约校验（字段/类型/可选性）。
- E2E：金样对比 + 两个冒烟脚本（preview/export）纳入 CI，未绿不许合并。

8) 构建/运行策略
- 本地：默认 `TURBOPACK=0 next dev`；next.config.mjs 将 duckdb 与 @mapbox/node-pre-gyp 标记 external，并为 .html 注册 loader。
- 环境：staging-intl（Vercel/S3/Upstash）与 prod-cn（阿里云/OSS/MNS/Redis）配置分离，变量名规范化（同一语义不同后端）。
- Feature Flag：未完成功能默认关闭；允许在 staging 打开验证。

9) 文档与Runbook
- 快速上手：本地开发三步（env、worker、web）。
- 故障处理：Upstash 认证失败、导出打包失败、预览无数据的排障流程。
- 数据字典：A–O 与汇总 6 列的口径说明与示例。
- 变更记录：适配器版本与口径变更日志（CHANGELOG.md）。

10) 法务与合规（MVP轻量版）
- 隐私：仅收集处理所需最小集；用户可请求删除其上传文件与产物。
- 中国场景：如涉及个人信息，遵循“最小必要、目的限定、明示同意”的设计；导出留水印/标识“仅用于财务核对”。

# PR 模板（追加两块必填）
- [ ] 安全与合规清单已过（上面 1/10 两节）（贴出 envalid 校验通过截图）
- [ ] 观测指标已出现（贴出一次处理的 metrics/日志）